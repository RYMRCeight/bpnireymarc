<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BP Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ========== GLOBAL ========== */
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: linear-gradient(135deg, #0d6efd, #4dabf7);
      min-height: 100vh;
    }

    /* ========== LAYOUT ========== */
    .layout {
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 18px;
      padding: 18px;
      height: 100vh;
    }

    .panel {
      background: #fff;
      border-radius: 22px;
      padding: 22px;
      display: flex;
      flex-direction: column;
      box-shadow:
        0 12px 25px rgba(0,0,0,.15),
        0 35px 60px rgba(0,0,0,.25);
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
        height: auto;
      }
    }

    /* ========== TYPOGRAPHY ========== */
    h2 {
      margin: 0 0 12px;
      text-align: center;
      color: #0d6efd;
    }

    label {
      font-size: 14px;
      font-weight: 600;
      margin-top: 10px;
    }

    /* ========== INPUTS ========== */
    input, select {
      width: 100%;
      padding: 13px;
      margin-top: 6px;
      border-radius: 12px;
      border: 1px solid #dee2e6;
      font-size: 16px;
    }

    /* ========== BUTTONS ========== */
    button {
      margin-top: 14px;
      padding: 14px;
      border-radius: 14px;
      border: none;
      background: #0d6efd;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(13,110,253,.35);
    }

    /* ========== INFO CARDS ========== */
    .info-card {
      background: #f8f9fa;
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
      font-size: 14px;
    }

    #bpHint {
      background: #e7f1ff;
      border-left: 5px solid #0d6efd;
    }

    /* ========== DASHBOARD ========== */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .tab {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: none;
      font-weight: bold;
      background: #e9ecef;
      cursor: pointer;
    }

    .tab.active {
      background: #0d6efd;
      color: #fff;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding-right: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    td {
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }

    .status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      color: #fff;
    }

    .normal { background:#198754; }
    .elevated { background:#ffc107; color:#000; }
    .stage1 { background:#fd7e14; }
    .stage2 { background:#dc3545; }
  </style>
</head>

<body>

<div class="layout">

  <!-- ADD BP -->
  <section class="panel">
    <h2>Add BP</h2>

    <div class="info-card" id="bpHint"></div>

    <label>User</label>
    <select id="user">
      <option>Reymarc</option>
      <option>Reyshien</option>
    </select>

    <label>Systolic</label>
    <input id="sys" type="number">

    <label>Diastolic</label>
    <input id="dia" type="number">

    <label>Pulse</label>
    <input id="pulse" type="number">

    <label>Notes</label>
    <input id="notes">

    <label>Before measuring</label>
    <select id="context">
      <option value="morning">Just woke up (before coffee)</option>
      <option value="coffee">Drank coffee / caffeine</option>
      <option value="exercise">Exercised recently</option>
      <option value="evening">Evening / before dinner</option>
    </select>

    <button onclick="saveBP()">Save</button>
    <div id="msg" style="text-align:center;margin-top:6px;"></div>
  </section>

  <!-- DASHBOARD -->
  <section class="panel">
    <h2>Health Dashboard</h2>

    <div class="tabs">
      <button class="tab active" onclick="selectUser('Reymarc', this)">Reymarc</button>
      <button class="tab" onclick="selectUser('Reyshien', this)">Reyshien</button>
    </div>

    <div class="content">
      <div class="info-card" id="statusCard"></div>

      <div class="info-card">
        <strong>BP Guide (WHO)</strong><br>
        ðŸŸ¢ Normal: &lt;120 / &lt;80<br>
        ðŸŸ¡ Elevated: 120â€“129 / &lt;80<br>
        ðŸŸ  Stage 1: 130â€“139 / 80â€“89<br>
        ðŸ”´ Stage 2: â‰¥140 / â‰¥90
      </div>

      <canvas id="chart" height="120"></canvas>
      <table id="table"></table>
    </div>
  </section>

</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbzVXUrlWf3yHVi6iVGOp7CwHCnneEdE0TmtAsCu461xxRVOt8S8PAcTaU9zh33S8wHJ/exec";

let allData = [];
let currentUser = "Reymarc";
let chart = null;

const bpHint = document.getElementById("bpHint");
const contextSelect = document.getElementById("context");
const table = document.getElementById("table");
const statusCard = document.getElementById("statusCard");
const chartEl = document.getElementById("chart");
const msg = document.getElementById("msg");

function updateBPAdvice() {
  const advice = {
    morning: "ðŸŒ… Best time to measure BP. Sit quietly for 5 minutes.",
    coffee: "â˜• Wait 30â€“60 minutes after caffeine.",
    exercise: "ðŸƒ Wait 30â€“60 minutes after exercise.",
    evening: "ðŸŒ™ Measure before dinner or 2â€“3 hours after meals."
  };
  bpHint.textContent = advice[contextSelect.value];
}
contextSelect.addEventListener("change", updateBPAdvice);
updateBPAdvice();

function saveBP() {
  fetch(URL, {
    method: "POST",
    body: JSON.stringify({
      user: user.value,
      systolic: sys.value,
      diastolic: dia.value,
      pulse: pulse.value,
      notes: notes.value,
      context: contextSelect.value
    })
  }).then(() => {
    msg.textContent = "Saved âœ”";
    sys.value = dia.value = pulse.value = notes.value = "";
    loadData();
  });
}

function loadData() {
  fetch(URL).then(r => r.json()).then(d => {
    allData = d.reverse();
    renderUser(currentUser);
  });
}

function selectUser(name, btn) {
  currentUser = name;
  document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  renderUser(name);
}

function isValidBP(sys, dia) {
  return (
    typeof sys === "number" &&
    typeof dia === "number" &&
    !isNaN(sys) &&
    !isNaN(dia) &&
    sys >= 60 && sys <= 240 &&
    dia >= 40 && dia <= 140
  );
}

function renderUser(name) {
  table.innerHTML = "";
  statusCard.innerHTML = "";
  if (chart) chart.destroy();

  const cleanData = allData
    .filter(r => String(r.User || "").trim() === name)
   .map(r => ({
  sys: Number(String(r.Systolic).replace(/[^\d.]/g, "")),
  dia: Number(String(r.Diastolic).replace(/[^\d.]/g, "")),
  pulse: Number(String(r.Pulse || "").replace(/[^\d.]/g, "")),
  date: new Date(r.Timestamp)
}))

    .filter(r => isValidBP(r.sys, r.dia) && !isNaN(r.date));

  if (!cleanData.length) {
    statusCard.textContent = "No valid BP readings.";
    return;
  }

  const latest = cleanData[0];

  let cls = "normal", label = "Normal";
  if (latest.sys >= 140 || latest.dia >= 90) {
    cls = "stage2"; label = "High (Stage 2)";
  } else if (latest.sys >= 130 || latest.dia >= 80) {
    cls = "stage1"; label = "High (Stage 1)";
  } else if (latest.sys >= 120) {
    cls = "elevated"; label = "Elevated";
  }

 statusCard.innerHTML = `
  <b>Latest BP:</b> ${latest.sys}/${latest.dia}
  <span class="status ${cls}">${label}</span>
  <br><b>Pulse:</b> ${latest.pulse || "-"} bpm
`;


  const labels = [];
  const sysArr = [];
  const diaArr = [];
  const pulseArr = [];

  cleanData.forEach(r => {
    labels.push(r.date.toLocaleDateString());
    sysArr.push(r.sys);
    diaArr.push(r.dia);
    pulseArr.push(r.pulse);

    table.innerHTML += `
  <tr>
    <td>${r.date.toLocaleDateString()}</td>
    <td><b>${r.sys}/${r.dia}</b></td>
    <td>${r.pulse || "-"}</td>
  </tr>
`;

  });

  chart = new Chart(chartEl, {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "SYS", data: sysArr, borderColor: "#dc3545" },
        { label: "DIA", data: diaArr, borderColor: "#0d6efd" }
        { label: "Pulse", data: pulseArr, borderColor: "#198754" }

      ]
    },
    options: {
      scales: {
        y: {
          min: 60,
          max: 180
        }
      }
    }
  });
}

loadData();
</script>

</body>
</html>

